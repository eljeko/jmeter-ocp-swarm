#!/bin/bash -e
#
# S2I run script for the 'jmeter-server-slave' image.
# The run script executes the server that runs your application.
#
# For more information see the documentation:
#	https://github.com/openshift/source-to-image/blob/master/docs/builder_image.md
#

curl $TEST_PLAN_URL > /home/jmeter/test-jmeter.jmx
sh /home/jmeter/bin/jmeter -n -t /home/jmeter/test-jmeter.jmx -l /home/jmeter/test-jmeter.jtl -Dserver.rmi.ssl.disable=true -R$JMETER_SLAVES

cat /home/jmeter/test-jmeter.jtl

curl -X POST --user demo:password \
  --form file0=@results//home/jmeter/test-jmeter.jtl \
  --form json='{"parameter": [{"name":'\"$APPLICATION_NAME\"', "file":"file0"}]}' \
  --form proceed=Proceed \
  $JENKINS_PIPELINE_RETURN_URL
